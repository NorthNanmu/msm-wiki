# 透明代理架构

本页基于 `/Users/doumao/code/github/msm/docs/透明代理架构详解.md` 归纳。

## 架构概览

MSM 透明代理采用 **MosDNS + 代理内核 + 系统转发规则** 的组合，实现全局无感代理：

- MosDNS：负责 DNS 分流与 FakeIP 解析
- 代理内核：负责透明代理、规则匹配与上游转发
- 系统转发：nftables / pfctl / TUN 等方式将流量导入代理

## 关键协同点

- **FakeIP 网段一致**：MosDNS 与代理内核的 FakeIP 段需保持一致（常用 `28.0.0.0/8`）
- **上游 DNS 分流**：国内域名直连，国外域名走代理上游
- **主路由路由规则**：需将 FakeIP 与特定地址段指向 Debian 主机

## 典型数据流

1. 客户端向 MosDNS 查询域名
2. 命中灰名单域名返回 FakeIP
3. 客户端访问 FakeIP 被系统规则重定向到代理内核
4. 代理内核通过 FakeIP 反查真实域名并匹配规则
5. 按规则转发到对应出口

## 适用场景

- 单机全局透明代理
- 旁路由模式接管局域网流量
- 需要观察分流效果的调试环境

## 注意事项

- 无 root 权限或不可修改系统网络栈的环境不适用
- 若使用 TUN 模式，请确认与系统防火墙策略兼容
- 变更后需观察 MosDNS 与代理日志确认生效
